Symbol=function(){};(function(global){function topologicalSort(a){function b(a){var d=[];if(a.inputs)for(var l=0;l<a.inputs.length;l++)a.inputs[l].name in c||b(a.inputs[l]),d.push(c[a.inputs[l].name]);c[a.name]=f.length;f.push(a);e.push(d)}for(var c={},f=[],e=[],d=0;d<a.length;d++)b(a[d]);return{index:c,order:f,dependencies:e}}
global.gradient=function(a,b){var c=topologicalSort(a),f=c.index,e=c.order,c=c.dependencies,d=Array(e.length);d[d.length-1]=ONE;for(var h=d.length-1;0<=h;h--)if(e[h].grad)for(var k=e[h].grad(d[h]),l=c[h],g=0;g<k.length;g++){var m=l[g],n=k[g];d[m]=d[m]?d[m].add(n):n}return b.map(function(a){return d[f[a]]})};
global.createFunction=function(a){var b=topologicalSort(a),c=b.order,f=b.dependencies,e=Array(c.length),d=function(a){return e[a]};console.log(b.index);return function(b){for(var k={},l=0,g=0;g<e.length;g++){var m=c[g];e[g]=m.fun?m.fun.apply(m,f[g].map(d)):b[m.name];m.name==a[l].name&&(k[m.name]=e[g],l++)}return k}};var Var=function(a){this.name=a};Var.prototype={toString:function(){return this.name}};Var.ONE=new Var("1");var Param=function(a,b){this.name=a;this.value=b;this.fun=function(){return this.value}};Param.prototype=new Var;Param.prototype.constructor=Param;global.Var=Var;global.Param=Param;var construct=function(a,b){function c(){return a.apply(this,b)}c.prototype=a.prototype;return new c},rowdot=function(a,b){for(var c=a.shape[0],f=b.shape[1],e=new Symbol.Array(f),d=0;d<f;d++){for(var h=0,k=0;k<c;k++)h+=a.data[k]*b.data[k][d];e.data[d]=h}return e},symbolicFunctionBuilder=function(a,b,c){function f(){this.inputs=Array.prototype.slice.call(arguments);this.name=a+"("+this.inputs.map(function(a){return a.name}).join(",")+")";this.fun=b;c&&(this.grad=c)}f.prototype=new Var;return function(){return construct(f,
arguments)}},elementWiseOpBuilder=function(a){var b=Array(a.length);return function(){for(var c=construct(Symbol.Array,arguments[0].shape),f=0;f<c.flattened.length;f++){for(var e=0;e<arguments.length;e++)b[e]=arguments[e].flattened[f];c.flattened[f]=a.apply(null,b)}return c}},pairwise=[{name:"add",op:elementWiseOpBuilder(function(a,b){return a+b}),grad:function(a){return[a,a]}},{name:"sub",op:elementWiseOpBuilder(function(a,b){return a-b})},{name:"mul",op:elementWiseOpBuilder(function(a,b){return a*
b}),grad:function(a){var b=this.inputs[0];return[this.inputs[1].mul(a),b.mul(a)]}},{name:"div",op:elementWiseOpBuilder(function(a,b){return a/b})},{name:"dot",op:rowdot}],single=[{name:"sigmoid",op:elementWiseOpBuilder(function(a){return 1/(1+Math.exp(-a))})},{name:"exp",op:elementWiseOpBuilder(function(a){return Math.exp(a)})},{name:"tanh",op:elementWiseOpBuilder(function(a){a=Math.exp(2*a);return(a-1)/(a+1)})}];
pairwise.forEach(function(a){var b=symbolicFunctionBuilder(a.name,a.op,a.grad);global[a.name]=b;Var.prototype[a.name]=function(a){return b(this,a)}});single.forEach(function(a){var b=symbolicFunctionBuilder(a.name,a.op,a.grad);global[a.name]=b});var PARAM_BYTES=4;global.Array=function(){function a(c,f){if(1<c.length)for(var e=Array(c[0]),d=0;d<c[0];d++)e[d]=a(c.slice(1),f);else e=new Float32Array(f,b*PARAM_BYTES,c[0]),b+=c[0];return e}this.shape=Array.prototype.slice.call(arguments);this.size=this.shape.reduce(function(a,b){return a*b},1);this.buffer=new ArrayBuffer(this.size*PARAM_BYTES);this.flattened=new Float32Array(this.buffer);var b=0;this.data=a(this.shape,this.buffer)};
global.Vector=function(a){for(var b=new Symbol.Array(a.length),c=0;c<a.length;c++)b.data[c]=a[c];return b};})(Symbol);
